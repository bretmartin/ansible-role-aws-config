---

- name: 'check status of AWS Config in {{ config_region }}'
  command: >
    aws configservice get-status
                      --region '{{ config_region }}'
                      --profile '{{ aws_profile }}'
  register: _aws_config_status
  changed_when: False


- block:

    - name: 'stop Config configuration recorders in {{ config_region }}'
      command: >
        aws configservice stop-configuration-recorder
                          --configuration-recorder-name default
                          --region {{ config_region }}
                          --profile {{ aws_profile }}

    - name: 'delete Config delivery channels in {{ config_region }}'
      command: >
        aws configservice delete-delivery-channel
                          --delivery-channel-name default
                          --region {{ config_region }}
                          --profile {{ aws_profile }}

    - name: 'delete SNS topic in {{ config_region }}'
      sns_topic:
        name: aws-config
        profile: '{{ aws_profile }}'
        region: '{{ config_region }}'
        state: absent

    - name: call optional notifier
      include_role:
        name: '{{ notifier_role }}'
      vars:
        message: >
          disabled <b>AWS Config</b> in
          <a href="{{ _aws_config_url }}?region={{ config_region }}">{{
            config_region }} in account {{ aws_profile }}</a>
      when: notifier_role is defined

  when: '"recorder: ON" in _aws_config_status.stdout_lines'
